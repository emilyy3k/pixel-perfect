import{hexToRgb}from"./lib/lib.js";let fragmentShader="#version 300 es\rprecision mediump float;\r\rout vec4 fragColor;\runiform sampler2D uOriginalTexture;\runiform vec2 uTexSize;\runiform float uSpriteAlpha;\runiform vec3 uSpriteTint;\r\runiform vec4 inputClampTarget;\r\rin vec2 vOriginalTextureCoord;\r\rfloat getClip(vec2 uv) {\rbvec4 inBounds = bvec4(\ruv.x >= inputClampTarget.x,\ruv.y >= inputClampTarget.y,\ruv.x <= inputClampTarget.z,\ruv.y <= inputClampTarget.w\r);\rreturn float(all(inBounds));\r}\r\rvoid main() {\rvec2 uv = vOriginalTextureCoord;\r\rvec2 dUVdx = dFdx(uv);\rvec2 dUVdy = dFdy(uv);\r\rvec2 originalSize = uTexSize;\r\rvec2 originalTexelSize = 1.0 / originalSize;\r\rvec2 boxSize = clamp((abs(dUVdx) + abs(dUVdy)) * originalSize, vec2(1e-5), vec2(1.0));\r\rvec2 tx = uv * originalSize - 0.5 * boxSize;\r\rvec2 txOffset = smoothstep(vec2(1.0) - boxSize, vec2(1.0), fract(tx));\r\rvec2 sampleUV = (floor(tx) + 0.5 + txOffset) * originalTexelSize;\r\rfloat clipValue = getClip(sampleUV);\r\rvec4 color = textureGrad(uOriginalTexture, clamp(sampleUV,inputClampTarget.xy,inputClampTarget.zw)*clipValue, dUVdx, dUVdy) * clipValue;\rcolor.rgb *= uSpriteTint;\rcolor *= uSpriteAlpha;\rfragColor = color;\r}",vertexShader="#version 300 es\rprecision mediump float;\rin vec2 aVertexPosition;\r\runiform mat3 projectionMatrix;\runiform mat3 uOriginalUVMatrix;\r\rout vec2 vTextureCoord;\rout vec2 vOriginalTextureCoord;\r\runiform vec4 inputSize;\runiform vec4 outputFrame;\r\rvec4 filterVertexPosition(void) {\rvec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.f)) + outputFrame.xy;\r\rreturn vec4((projectionMatrix * vec3(position, 1.0f)).xy, 0.0f, 1.0f);\r}\r\rvec2 filterTextureCoord(void) {\rreturn aVertexPosition * (outputFrame.zw * inputSize.zw);\r}\r\rvoid main(void) {\rgl_Position = filterVertexPosition();\rvTextureCoord = filterTextureCoord();\r\rvOriginalTextureCoord = (uOriginalUVMatrix * vec3(vTextureCoord, 1.0f)).xy;\r}";class PixelPerfectFilter extends PIXI.Filter{originalUVMatrix;targetSprite;originalTexture;lastWorldID=-1;filterCount=0;constructor(r){var e=new PIXI.Matrix;super(vertexShader,fragmentShader),this.uniforms.uOriginalUVMatrix=e,this.originalUVMatrix=e,this.filterCount=r.mesh?.filters?.length||0,r?.texture?(this.updatePlaceableData(r),console.log("pixel-perfect: Texture assigned to filter")):console.warn(`pixel-perfect: No texture found for placeable ${r.id}, skipping filter application.`),this.autoFit=!1}updateSpriteData(r){var e;r.texture&&((e=r.texture).valid?((this.originalTexture=e).uvMatrix||(e.uvMatrix=new PIXI.TextureMatrix(e,0),e.uvMatrix.update()),this.uniforms.uOriginalTexture!==this.originalTexture&&(this.uniforms.uOriginalTexture=this.originalTexture,this.uniforms.uTexSize=[e.width,e.height]),r.roundPixels||(r.roundPixels=!0),this.targetSprite!==r&&(this.targetSprite=r)):console.warn(`pixel-perfect: Texture is not valid for sprite mesh ${r}, skipping filter application.`))}updatePlaceableData(e){var i=e.mesh;if(i){this.lastWorldID=-1,this.updateSpriteData(i);var i=e.document?.alpha||1;this.uniforms.uSpriteAlpha!==i&&(this.uniforms.uSpriteAlpha=i);let r=null;null!==(r=game.release&&12<=parseFloat(game.release.version)?e.document?.texture?.tint?.rgb||[1,1,1]:(i=e.document?.texture?.tint||"#ffffff",hexToRgb(i)))&&this.uniforms.uSpriteTint!==r&&(this.uniforms.uSpriteTint=r)}else console.warn(`pixel-perfect: No sprite mesh found for placeable ${e.id}, skipping filter application.`)}apply(r,e,i,t){var a=this.originalTexture,o=(this.uniforms.uOriginalTexture!==a&&(this.uniforms.uOriginalTexture=a),this.targetSprite.transform._worldID!==this.lastWorldID||this.targetSprite.filters?.length!==this.filterCount);o&&(this.uniforms.uOriginalUVMatrix=r.calculateSpriteMatrix(this.originalUVMatrix,this.targetSprite).prepend(a.uvMatrix.mapCoord),this.lastWorldID=this.targetSprite.transform._worldID,this.filterCount=this.targetSprite.filters?.length||0),this.uniforms.inputClampTarget=a.uvMatrix.uClampFrame,super.apply(r,e,i,t)}destroy(){this.originalTexture=void 0,this.targetSprite=void 0,this.originalUVMatrix=void 0,this.lastWorldID=-1,super.destroy()}}export{PixelPerfectFilter};
//# sourceMappingURL=PixelArtFilter.js.map
